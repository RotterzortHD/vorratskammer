<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vorratskammer</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
      max-width: 600px;
    }
    input, button, select {
      margin: 0.5rem 0;
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }
    .produkt {
      border: 1px solid #ccc;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      position: relative;
    }
    .abgelaufen {
      background-color: #fdd;
      border-color: #f00;
    }
    .bald-abgelaufen {
      background-color: #ffe8b3;
      border-color: #ff9900;
    }
    .frisch {
      background-color: #e6ffe6;
      border-color: #33cc33;
    }
    #reader {
      width: 100%;
      max-width: 300px;
      margin-bottom: 1rem;
      aspect-ratio: 4 / 3;
      display: none;
      border: 2px solid #333;
      border-radius: 8px;
    }
    .btn-klein {
      font-size: 0.9rem;
      padding: 0.3rem 0.5rem;
      margin-left: 0.3rem;
    }
    .edit-felder input {
      width: 45%;
      margin-right: 5%;
    }
    .edit-felder {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>üß∫ Meine Vorratskammer</h1>

  <button onclick="startScanner()">üì∑ Barcode scannen</button>
  <div id="reader"></div>

  <input type="text" id="suchfeld" placeholder="üîç Produkt suchen..." oninput="anzeigen()" />

  <input type="text" id="name" placeholder="Produktname" />
  <input type="text" id="menge" placeholder="Menge (z. B. 1 Packung)" />
  <input type="date" id="haltbarkeit" />
  <button onclick="hinzufuegen()">‚ûï Produkt hinzuf√ºgen</button>

  <h2>üìã Lagerbestand</h2>
  <div id="liste"></div>

  <!-- Bibliothek laden -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    let produkte = JSON.parse(localStorage.getItem('produkte')) || [];
    let qrCodeScanner = null;

    function saveProdukte() {
      localStorage.setItem('produkte', JSON.stringify(produkte));
    }

    function datumStatus(haltbarkeit) {
      if (!haltbarkeit) return 'frisch';
      const heute = new Date();
      const haltbDatum = new Date(haltbarkeit);
      const diff = (haltbDatum - heute) / (1000*60*60*24);
      if (diff < 0) return 'abgelaufen';
      if (diff <= 7) return 'bald-abgelaufen';
      return 'frisch';
    }

    window.anzeigen = function() {
      const liste = document.getElementById('liste');
      const filter = document.getElementById('suchfeld').value.toLowerCase();
      liste.innerHTML = '';

      produkte.forEach((p, index) => {
        if (!p.name.toLowerCase().includes(filter)) return;

        const status = datumStatus(p.haltbarkeit);
        const div = document.createElement('div');
        div.className = `produkt ${status}`;

        // Wenn Produkt gerade editiert wird
        if (p.edit) {
          div.innerHTML = `
            <div class="edit-felder">
              <input type="text" id="edit-name-${index}" value="${p.name}" />
              <input type="text" id="edit-menge-${index}" value="${p.menge}" />
              <input type="date" id="edit-haltbarkeit-${index}" value="${p.haltbarkeit || ''}" />
            </div>
            <button class="btn-klein" onclick="speichern(${index})">üíæ Speichern</button>
            <button class="btn-klein" onclick="abbrechen(${index})">‚ùå Abbrechen</button>
          `;
        } else {
          div.innerHTML = `
            <strong>${p.name}</strong><br>
            Menge: ${p.menge}<br>
            Haltbar bis: ${p.haltbarkeit || 'unbekannt'}<br>
            <button class="btn-klein" onclick="bearbeiten(${index})">‚úèÔ∏è Bearbeiten</button>
            <button class="btn-klein" onclick="loeschen(${index})">üóëÔ∏è Entfernen</button>
          `;
        }

        liste.appendChild(div);
      });
    }

    window.hinzufuegen = function() {
      const name = document.getElementById('name').value.trim();
      const menge = document.getElementById('menge').value.trim();
      const haltbarkeit = document.getElementById('haltbarkeit').value;

      if (!name || !menge) {
        alert('Bitte Name und Menge eingeben.');
        return;
      }

      // Pr√ºfen ob Produkt schon existiert (Name ignoriert Gro√ü-/Kleinschreibung)
      const existierenderIndex = produkte.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
      if (existierenderIndex !== -1) {
        // Menge addieren
        produkte[existierenderIndex].menge = addMengen(produkte[existierenderIndex].menge, menge);
        // Haltbarkeit aktualisieren, wenn neuer Wert gesetzt und fr√ºher
        if (haltbarkeit) {
          if (!produkte[existierenderIndex].haltbarkeit || new Date(haltbarkeit) < new Date(produkte[existierenderIndex].haltbarkeit)) {
            produkte[existierenderIndex].haltbarkeit = haltbarkeit;
          }
        }
      } else {
        produkte.push({ name, menge, haltbarkeit });
      }

      saveProdukte();
      anzeigen();

      // Felder zur√ºcksetzen
      document.getElementById('name').value = '';
      document.getElementById('menge').value = '';
      document.getElementById('haltbarkeit').value = '';
    }

    // Hilfsfunktion um Mengen zusammenzurechnen (einfache Implementierung)
    function addMengen(mengeAlt, mengeNeu) {
      // Wenn beide Mengen wie "1 St√ºck", "2 Packungen" sind, werden nur die Zahlen addiert, Einheit bleibt erhalten
      const regex = /^(\d+)\s*(.*)$/;
      const altMatch = mengeAlt.match(regex);
      const neuMatch = mengeNeu.match(regex);
      if (altMatch && neuMatch && altMatch[2] === neuMatch[2]) {
        const sum = parseInt(altMatch[1]) + parseInt(neuMatch[1]);
        return sum + ' ' + altMatch[2];
      }
      // Wenn nicht parsebar, einfach die neue Menge anf√ºgen, getrennt mit Komma
      return mengeAlt + ', ' + mengeNeu;
    }

    window.loeschen = function(index) {
      if (confirm(`Produkt "${produkte[index].name}" wirklich entfernen?`)) {
        produkte.splice(index, 1);
        saveProdukte();
        anzeigen();
      }
    }

    window.bearbeiten = function(index) {
      produkte[index].edit = true;
      anzeigen();
    }

    window.speichern = function(index) {
      const nameNeu = document.getElementById(`edit-name-${index}`).value.trim();
      const mengeNeu = document.getElementById(`edit-menge-${index}`).value.trim();
      const haltbNeu = document.getElementById(`edit-haltbarkeit-${index}`).value;

      if (!nameNeu || !mengeNeu) {
        alert('Name und Menge d√ºrfen nicht leer sein.');
        return;
      }

      produkte[index] = {
        name: nameNeu,
        menge: mengeNeu,
        haltbarkeit: haltbNeu,
      };

      delete produkte[index].edit;
      saveProdukte();
      anzeigen();
    }

    window.abbrechen = function(index) {
      delete produkte[index].edit;
      anzeigen();
    }

window.startScanner = async function() {
  const reader = document.getElementById('reader');
  reader.style.display = 'block';

  try {
    const cameras = await Html5Qrcode.getCameras();
    if (!cameras.length) throw new Error("Keine Kamera gefunden");

    const backCamera = cameras.find(c => !c.label.toLowerCase().includes('front')) || cameras[0];

    if (qrCodeScanner) {
      try { await qrCodeScanner.stop(); await qrCodeScanner.clear(); } catch {}
      qrCodeScanner = null;
    }
    qrCodeScanner = new Html5Qrcode("reader");

    await qrCodeScanner.start(
      { deviceId: { exact: backCamera.id } },
      {
        fps: 25,                             // H√∂here Kadenz f√ºr schnellere Erkennung
        qrbox: { width: 250, height: 100 }, // Kleinere Box bedeutet weniger Bilddaten :contentReference[oaicite:1]{index=1}
        formatsToSupport: [                  // Nur ben√∂tigte Formate scannen
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.UPC_A
        ],
        experimentalFeatures: {
          useBarCodeDetectorIfSupported: true // Nutzt optimierte native API bei Bedarf :contentReference[oaicite:2]{index=2}
        },
        disableFlip: true                     // Verzicht auf Flip als Performance-Tuning
      },
      async (barcode) => {
        console.log("Schneller Barcode gescannt:", barcode);
        try { await qrCodeScanner.stop(); await qrCodeScanner.clear(); } catch {}
        reader.style.display = 'none';
        qrCodeScanner = null;

        const prod = await fetchProduktname(barcode);
        if (prod) {
          // Menge direkt erh√∂hen, falls vorhanden
          const idx = produkte.findIndex(p => p.name.toLowerCase() === prod.toLowerCase());
          if (idx !== -1) {
            produkte[idx].menge = addMengen(produkte[idx].menge, '1 St√ºck');
          } else {
            produkte.push({ name: prod, menge: '1 St√ºck', haltbarkeit: '' });
          }
          saveProdukte();
          anzeigen();
        } else {
          document.getElementById('name').value = prod;
          document.getElementById('menge').value = '1 St√ºck';
          document.getElementById('haltbarkeit').value = '';
          alert("Produkt nicht gefunden. Bitte manuell eingeben.");
        }
      },
      (err) => {/* Scan-Fehler ignorieren */}
    );
  } catch (e) {
    :contentReference[oaicite:3]{index=3}
    qrCodeScanner = null;
    :contentReference[oaicite:4]{index=4}\n" + e.message);
  }
};
      } catch (err) {
        reader.style.display = 'none';
        alert("Kamera-Zugriff fehlgeschlagen:\n" + err.message);
      }
    }

    async function fetchProduktname(barcode) {
      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
        const data = await res.json();
        if (data.status === 1) {
          return data.product.product_name || "Unbenanntes Produkt";
        }
      } catch (e) {
        console.error("API-Fehler:", e);
      }
      return null;
    }

    // Beim Laden anzeigen
    anzeigen();
  </script>
</body>
</html>
